name: AI Issue Triage

on:
  issues:
    types: [opened, edited]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: AI Issue Analysis
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            const issueTitle = issue.title || '';
            const labels = issue.labels.map(l => l.name);
            
            // Determine issue type and priority
            let issueType = 'question';
            let priority = 'medium';
            let analysis = '';
            
            if (labels.includes('bug') || issueTitle.toLowerCase().includes('[bug]')) {
              issueType = 'bug';
              
              // Analyze bug severity
              if (issueBody.toLowerCase().includes('crash') || 
                  issueBody.toLowerCase().includes('not working') ||
                  issueBody.toLowerCase().includes('error')) {
                priority = 'high';
              }
              
              analysis = "ðŸ› **Bug Report Detected**\n\n" +
                "**Priority:** " + priority.toUpperCase() + "\n" +
                "**Type:** " + issueType + "\n\n" +
                "**AI Analysis:**\n" +
                "- This appears to be a bug report\n" +
                "- Priority level: " + priority + "\n" +
                "- Recommended action: Investigate and reproduce the issue\n\n" +
                "**Next Steps for Maintainer:**\n" +
                "1. Review the reproduction steps\n" +
                "2. Check if this affects multiple users\n" +
                "3. Test in local environment\n" +
                "4. Fix in private repository\n" +
                "5. Deploy and verify\n" +
                "6. Close this issue with resolution details\n\n" +
                "---\n" +
                "*This analysis was generated automatically. @Zerr0-C00L please review.*";
              
            } else if (labels.includes('enhancement') || issueTitle.toLowerCase().includes('[feature]')) {
              issueType = 'feature';
              priority = 'medium';
              
              analysis = "ðŸ’¡ **Feature Request Detected**\n\n" +
                "**Priority:** " + priority.toUpperCase() + "\n" +
                "**Type:** " + issueType + "\n\n" +
                "**AI Analysis:**\n" +
                "- This is a feature request\n" +
                "- Community feedback: Consider gathering more input\n" +
                "- Implementation complexity: Needs assessment\n\n" +
                "**Next Steps for Maintainer:**\n" +
                "1. Evaluate feasibility and impact\n" +
                "2. Determine if this aligns with roadmap\n" +
                "3. Estimate implementation effort\n" +
                "4. Add to backlog or start development\n" +
                "5. Update issue with timeline\n\n" +
                "---\n" +
                "*This analysis was generated automatically. @Zerr0-C00L please review.*";
              
            } else {
              issueType = 'question';
              priority = 'low';
              
              analysis = "â“ **Question/Support Request Detected**\n\n" +
                "**Priority:** " + priority.toUpperCase() + "\n" +
                "**Type:** " + issueType + "\n\n" +
                "**AI Analysis:**\n" +
                "- This appears to be a support question\n" +
                "- May be resolved with documentation\n" +
                "- Could benefit from FAQ entry\n\n" +
                "**Next Steps for Maintainer:**\n" +
                "1. Provide answer or guidance\n" +
                "2. Link to relevant documentation\n" +
                "3. Consider adding to FAQ if common question\n" +
                "4. Close once resolved\n\n" +
                "---\n" +
                "*This analysis was generated automatically. @Zerr0-C00L please review.*";
            }
            
            // Post AI analysis as comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: analysis
            });
            
            // Add appropriate labels if not already present
            const labelsToAdd = [];
            if (priority === 'high' && !labels.includes('needs-triage')) {
              labelsToAdd.push('needs-triage');
            }
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }
      
      - name: Notify Maintainer
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // Log for maintainer
            console.log('ðŸ“¬ New Issue Created:');
            console.log(`Title: ${issue.title}`);
            console.log(`Number: #${issue.number}`);
            console.log(`URL: ${issue.html_url}`);
            console.log(`Reporter: @${issue.user.login}`);
            console.log('\nðŸ¤– AI analysis has been posted as a comment.');
            console.log('\nâœ… Review the AI analysis and take action as needed.');
